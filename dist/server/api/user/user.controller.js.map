{"version":3,"sources":["../../../../server/api/user/user.controller.js"],"names":[],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\n\nimport {User} from '../../sqldb';\nimport passport from 'passport';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    res.status(statusCode).json(err);\n  }\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\nfunction respondWith(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function() {\n    res.status(statusCode).end();\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexports.index = function(req, res) {\n  User.findAll({\n    attributes: [\n      '_id',\n      'name',\n      'email',\n      'role',\n      'provider'\n    ]\n  })\n    .then(function(users) {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n};\n\n/**\n * Creates a new user\n */\nexports.create = function(req, res, next) {\n  var newUser = User.build(req.body);\n  newUser.setDataValue('provider', 'local');\n  newUser.setDataValue('role', 'user');\n  newUser.save()\n    .then(function(user) {\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n        expiresInMinutes: 60 * 5\n      });\n      res.json({ token: token });\n    })\n    .catch(validationError(res));\n};\n\n/**\n * Get a single user\n */\nexports.show = function(req, res, next) {\n  var userId = req.params.id;\n\n  User.find({\n    where: {\n      _id: userId\n    }\n  })\n    .then(function(user) {\n      if (!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n    })\n    .catch(function(err) {\n      return next(err);\n    });\n};\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexports.destroy = function(req, res) {\n  User.destroy({ _id: req.params.id })\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n};\n\n/**\n * Change a users password\n */\nexports.changePassword = function(req, res, next) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  User.find({\n    where: {\n      _id: userId\n    }\n  })\n    .then(function(user) {\n      if (user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.save()\n          .then(function() {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n};\n\n/**\n * Get my info\n */\nexports.me = function(req, res, next) {\n  var userId = req.user._id;\n\n  User.find({\n    where: {\n      _id: userId\n    },\n    attributes: [\n      '_id',\n      'name',\n      'email',\n      'role',\n      'provider'\n    ]\n  })\n    .then(function(user) { // don't ever give out the password or salt\n      if (!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n    })\n    .catch(function(err) {\n      return next(err);\n    });\n};\n\n/**\n * Authentication callback\n */\nexports.authCallback = function(req, res, next) {\n  res.redirect('/');\n};\n"]}